<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Estrazione Giocatori Soccerverse</title>
</head>
<body>

  <h1>Estrazione giocatori senza agente</h1>

  <label for="startId">ID iniziale:</label>
  <input type="number" id="startId" placeholder="es. 1" />

  <label for="minRatio">Min Ratio (stipendio / valore):</label>
  <input type="number" step="0.01" id="minRatio" placeholder="es. 0.02" />

  <br><br>

  <button onclick="startExtraction()">‚ñ∂Ô∏è Avvia Estrazione</button>
  <button onclick="stopExtraction()">‚èπÔ∏è Ferma</button>
  <button onclick="resetProgress()">üîÑ Resetta</button>

  <div id="log" style="margin-top: 20px; white-space: pre-wrap; font-family: monospace; max-height: 400px; overflow-y: auto;"></div>

  <script>
    let stopRequested = false;

    function log(message) {
      const logDiv = document.getElementById("log");
      logDiv.textContent += message + "\n";
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function startExtraction() {
      stopRequested = false;

      // Leggi i parametri inseriti dall'utente
      let playerId = parseInt(document.getElementById("startId").value) || parseInt(localStorage.getItem('playerId')) || 1;
      const minRatio = parseFloat(document.getElementById("minRatio").value) || 0;

      async function processPlayer(id) {
        if (stopRequested) {
          log("üîÅ Estrazione fermata a ID " + id);
          return;
        }

        try {
          const url = `https://corsproxy.io/?https://api.soccerverse.io/players/detailed?player_id=${id}`;
          const response = await fetch(url);
          if (!response.ok) throw new Error("Errore nella risposta");

          const data = await response.json();

          if (data && data.agent === null && data.salary && data.value) {
            const ratio = data.salary / data.value;

            if (ratio >= minRatio) {
              log(`‚úÖ ID ${id} - ${data.name} | Ratio: ${ratio.toFixed(4)} ‚úÖ`);
              // Puoi anche salvarli in array per download o uso successivo
            } else {
              log(`‚ÑπÔ∏è  ID ${id} - Ratio troppo basso: ${ratio.toFixed(4)}`);
            }
          } else {
            log(`üö´ ID ${id} - Ha agente o dati incompleti`);
          }

          // Salva progressi
          localStorage.setItem('playerId', id + 1);

          // Prossimo
          setTimeout(() => processPlayer(id + 1), 400);

        } catch (e) {
          log(`‚ùå Errore per ID ${id}: ${e.message}`);
          // Salta comunque al prossimo
          setTimeout(() => processPlayer(id + 1), 1000);
        }
      }

      processPlayer(playerId);
    }

    function stopExtraction() {
      stopRequested = true;
    }

    function resetProgress() {
      localStorage.removeItem('playerId');
      log("üîÑ Progressi azzerati. Si ripartir√† da ID specificato.");
    }
  </script>

</body>
</html>
